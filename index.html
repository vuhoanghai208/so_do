<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sơ đồ tư duy - Nam Cao</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* CSS cho toàn bộ trang */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000; /* Nền đen cho không gian */
        }
        
        /* Canvas cho 3D background */
        #bg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Nằm ở lớp dưới */
        }

        /* SVG cho D3 Mindmap */
        svg {
            position: absolute; /* Đặt SVG lên trên canvas */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2; /* Nằm ở lớp trên */
            background-color: transparent; /* Nền trong suốt để thấy canvas */
            cursor: move;
        }

        /* Kiểu dáng cho các đường liên kết (paths) */
        .link {
            fill: none;
            stroke: #ddd;
            stroke-opacity: 0.5;
            stroke-width: 1.5px;
        }

        /* Kiểu dáng chung cho các nút (node) */
        .node circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        /* Kiểu dáng cho văn bản (text) của nút */
        .node text {
            /* Kích thước chữ sẽ được set bằng JS */
            font-weight: 500;
            fill: #fff; /* Chữ trắng */
            paint-order: stroke;
            stroke: #000; /* Viền đen cho chữ */
            stroke-width: 3px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
            pointer-events: none;
        }

        /* Căn chỉnh text */
        .node.leaf text { text-anchor: start; }
        .node.internal text, .node.root text, .node.collapsed text { text-anchor: end; }

        /* Kiểu dáng nút dựa trên trạng thái */
        .node.root circle { fill: #d62728; }
        .node.internal circle { fill: #1f77b4; cursor: pointer; }
        .node.collapsed circle { fill: #aec7e8; cursor: pointer; }
        .node.leaf circle { fill: #ff7f0e; }
        
        /* Biểu tượng Cài Đặt (Bánh răng) */
        #settings-toggle-icon {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 4;
            cursor: pointer;
            width: 40px;
            height: 40px;
            padding: 5px;
            background: rgba(31, 119, 180, 0.8);
            border-radius: 50%;
            box-sizing: border-box;
            transition: transform 0.3s ease;
        }
        #settings-toggle-icon:hover {
            transform: rotate(60deg);
        }
        #settings-toggle-icon svg {
            width: 100%;
            height: 100%;
            fill: #fff;
        }

        /* Bảng điều khiển (menu drop-up) */
        #settings-panel {
            position: absolute;
            bottom: 70px; /* Ngay trên nút Cài Đặt */
            right: 20px;
            z-index: 3;
            display: none; /* Ẩn mặc định */
            flex-direction: column;
            gap: 15px; /* Khoảng cách giữa các thanh trượt */
            background: rgba(20,20,20,0.85);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #555;
            width: 250px;
        }

        /* Lớp .open để hiển thị Bảng điều khiển */
        #settings-panel.open {
            display: flex;
        }

        /* Style chung cho các nhóm control */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 12px;
            color: #fff;
            font-weight: bold;
        }
        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    
    <canvas id="bg-canvas"></canvas>
    
    <svg id="mindmap"></svg>

    <div id="settings-toggle-icon">
        <svg viewBox="0 0 24 24">
            <path d="M19.4 12.9c.1-.3.1-.6.1-.9s0-.6-.1-.9l2.1-1.6c.2-.1.2-.4.1-.6l-2-3.5c-.1-.2-.4-.2-.6-.1l-2.5 1c-.5-.4-.9-.7-1.4-1l-.4-2.8c0-.2-.2-.4-.4-.4h-4c-.2 0-.4.2-.4.4l-.4 2.8c-.5.3-1 .6-1.4 1l-2.5-1c-.2-.1-.5 0-.6.1l-2 3.5c-.1.2-.1.5.1.6l2.1 1.6c-.1.3-.1.6-.1.9s0 .6.1.9l-2.1 1.6c-.2.1-.2.4-.1.6l2 3.5c.1.2.4.2.6.1l2.5-1c.5.4.9.7 1.4 1l.4 2.8c0 .2.2.4.4.4h4c.2 0 .4-.2.4.4l.4-2.8c.5-.3 1-.6 1.4-1l2.5 1c.2.1.5 0 .6-.1l2 3.5c.1-.2.1-.5-.1-.6l-2.1-1.6zM12 15.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5z"/>
        </svg>
    </div>

    <div id="settings-panel">
        <div class="control-group">
            <label for="element-size-slider">KÍCH THƯỚC CHỮ/NÚT</label>
            <input type="range" id="element-size-slider" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>
        <div class="control-group">
            <label for="vspacing-slider">SIZE (KHOẢNG CÁCH DỌC)</label>
            <input type="range" id="vspacing-slider" min="10" max="100" step="1" value="35">
        </div>
        <div class="control-group">
            <label for="spacing-slider">SIZE (KHOẢNG CÁCH NGANG)</label>
            <input type="range" id="spacing-slider" min="50" max="500" step="5" value="220">
        </div>
    </div>

    <script>
        // --- KỊCH BẢN NỀN 3D (THREE.JS) ---
        
        let scene, camera, renderer, starField;
        let asteroids = []; // Mảng chứa các thiên thạch
        const canvas = document.getElementById('bg-canvas');
        const textureLoader = new THREE.TextureLoader();
        textureLoader.crossOrigin = "anonymous"; // <<< FIX LỖI "Script error"
        let fireTexture;

        function initThreeJS() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 100;

            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1, 0);
            pointLight.position.set(50, 50, 50);
            scene.add(pointLight);

            // 1. Vũ trụ đầy sao
            const starCount = 10000;
            const starVertices = [];
            for (let i = 0; i < starCount; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                starVertices.push(x, y, z);
            }
            const starGeometry = new THREE.BufferGeometry();
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const starMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.15,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.8
            });
            starField = new THREE.Points(starGeometry, starMaterial);
            scene.add(starField);

            // 2. Tải texture lửa (dùng cho thiên thạch cháy)
            // *** ĐÃ SỬA LỖI 404 ***
            fireTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/sprites/fire1.png');

            // 3. Tạo các thiên thạch
            const asteroidGeometry = new THREE.IcosahedronGeometry(1, 0);
            const asteroidMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xaaaaaa, 
                flatShading: true 
            });

            for (let i = 0; i < 30; i++) {
                const asteroid = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
                
                asteroid.position.set(
                    (Math.random() - 0.5) * 150,
                    (Math.random() - 0.5) * 150,
                    (Math.random() * -900) - 100 // Bắt đầu ở xa
                );

                let scale = Math.random() * 2 + 0.5;
                let isBigAndBurning = false;

                // 10% cơ hội là thiên thạch TO và CHÁY
                if (Math.random() < 0.1) { 
                    scale = Math.random() * 7 + 5; // To hơn hẳn
                    isBigAndBurning = true;
                }
                
                asteroid.scale.set(scale, scale, scale);
                asteroid.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
                scene.add(asteroid);

                const asteroidData = {
                    mesh: asteroid,
                    velocity: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.05,
                        (Math.random() - 0.5) * 0.05,
                        Math.random() * 0.2 + 0.1 // Luôn bay về phía camera
                    ),
                    rotationSpeed: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.01,
                        (Math.random() - 0.5) * 0.01,
                        (Math.random() - 0.5) * 0.01
                    ),
                    isBigAndBurning: isBigAndBurning,
                    fireEffect: null
                };

                if (isBigAndBurning) {
                    const fireMaterial = new THREE.SpriteMaterial({ 
                        map: fireTexture, 
                        color: 0xffa500,
                        transparent: true, 
                        blending: THREE.AdditiveBlending 
                    });
                    const fireSprite = new THREE.Sprite(fireMaterial);
                    fireSprite.scale.set(scale * 1.5, scale * 1.5, scale * 1.5); // Lửa to hơn thiên thạch
                    asteroidData.fireEffect = fireSprite;
                    asteroid.add(fireSprite); // Gắn lửa vào thiên thạch
                }
                asteroids.push(asteroidData);
            }

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        // Vòng lặp hoạt ảnh
        function animate() {
            requestAnimationFrame(animate);
            
            starField.rotation.x += 0.0001;
            starField.rotation.y += 0.0001;

            asteroids.forEach(obj => {
                obj.mesh.position.add(obj.velocity);
                obj.mesh.rotation.x += obj.rotationSpeed.x;
                obj.mesh.rotation.y += obj.rotationSpeed.y;
                obj.mesh.rotation.z += obj.rotationSpeed.z;

                // Nếu bay quá camera, đưa trở lại "không gian sâu"
                if (obj.mesh.position.z > camera.position.z) { 
                    obj.mesh.position.z = (Math.random() * -900) - 100;
                    obj.mesh.position.x = (Math.random() - 0.5) * 150;
                    obj.mesh.position.y = (Math.random() - 0.5) * 150;
                }

                if (obj.isBigAndBurning && obj.fireEffect) {
                    obj.fireEffect.material.opacity = 0.5 + Math.sin(Date.now() * 0.005) * 0.2; // Nhấp nháy nhẹ
                }
            });

            renderer.render(scene, camera);
        }

        // Cập nhật khi thay đổi kích thước
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            resizeD3();
        }

        initThreeJS();

    </script>

    <script>
        // --- KỊCH BẢN SƠ ĐỒ TƯ DUY (D3.JS) ---
        
        const jsonData = {
          "name": "Nam Cao (1915–1951)",
          "children": [
            {
              "name": "Tiểu sử",
              "children": [
                { "name": "Tên thật: Trần Hữu Tri" },
                { "name": "Quê quán: Đại Hoàng, Lý Nhân, Hà Nam" },
                { "name": "Gia đình: Công giáo, bậc trung" },
                { "name": "Học vấn: Học ở trường làng, sau xuống Nam Định học" },
                { "name": "Sự nghiệp ban đầu: Thư ký ở Sài Gòn, dạy học ở Hà Nội" },
                { "name": "Tham gia cách mạng: Gia nhập Hội Văn hóa cứu quốc (1943)" },
                { "name": "Gia nhập Đảng Cộng sản Việt Nam: 1948" },
                { "name": "Làm việc tại Hội Văn nghệ Việt Nam (1950)" }
              ]
            },
            {
              "name": "Sự nghiệp sáng tác",
              "children": [
                {
                  "name": "Quan điểm sáng tác",
                  "children": [
                    { "name": "Nghệ thuật vị nhân sinh: 'Nghệ thuật không nên là ánh trăng lừa dối...'" },
                    { "name": "Tác phẩm phải chứa đựng điều lớn lao, mạnh mẽ, vừa đau đớn vừa phấn khởi" },
                    { "name": "Văn chương phải sáng tạo, không theo khuôn mẫu" }
                  ]
                },
                {
                  "name": "Tác phẩm chính",
                  "children": [
                    { "name": "Chí Phèo" },
                    { "name": "Lão Hạc" },
                    { "name": "Sống mòn" },
                    { "name": "Giăng sáng" },
                    { "name": "Đôi mắt" }
                  ]
                },
                {
                  "name": "Phong cách nghệ thuật",
                  "children": [
                    { "name": "Quan tâm đời sống tinh thần con người" },
                    { "name": "Khám phá nội tâm nhân vật" },
                    { "name": "Triết lý trữ tình, sắc lạnh" },
                    { "name": "Viết về cái nhỏ nhặt nhưng mang ý nghĩa lớn" }
                  ]
                }
              ]
            },
            {
              "name": "Vị trí và tầm ảnh hưởng",
              "children": [
                { "name": "Nhà văn lớn, cây bút xuất sắc của văn học hiện đại" },
                { "name": "Đại diện xuất sắc cho chủ nghĩa hiện thực nhân đạo thế kỷ XX" },
                { "name": "Đưa chủ nghĩa hiện thực lên tầm tâm lý" },
                { "name": "Giải thưởng Hồ Chí Minh về Văn học Nghệ thuật (1996)" }
              ]
            }
          ]
        };

        // Biến toàn cục cho kích thước
        let globalNodeHeight = 35;
        let globalNodeWidth = 220;
        let globalElementScale = 1.0;
        
        // Cài đặt D3
        const margin = { top: 20, right: 120, bottom: 20, left: 120 };
        let width = window.innerWidth;
        let height = window.innerHeight;
        
        const svgD3 = d3.select("#mindmap").attr("viewBox", [0, 0, width, height]);

        // *** ĐÃ SỬA LỖI D3 ***
        // Đóng bảng cài đặt khi nhấp vào nền SVG
        svgD3.on("click", () => {
            if (settingsPanel.classList.contains('open')) {
                settingsPanel.classList.remove('open');
            }
        });

        const g = svgD3.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        const treeLayout = d3.tree().nodeSize([globalNodeHeight, globalNodeWidth]);
        const root = d3.hierarchy(jsonData);
        root.x0 = height / 2;
        root.y0 = 0;

        // Đóng tất cả các nút con ban đầu
        root.descendants().forEach((d, i) => {
            d.id = i;
            d._children = d.children;
            if (d.depth > 0) { // Đóng hết, chỉ chừa lại nút gốc
                d.children = null;
            }
        });

        // Thiết lập Zoom
        // *** ĐÃ SỬA LỖI D3 ***
        // (Đã xóa .on("click.zoom", ...) khỏi đây)
        const zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });
        
        svgD3.call(zoom);
        // Đẩy sơ đồ vào 300px từ lề trái
svgD3.call(zoom.transform, d3.zoomIdentity.translate(300, height / 2).scale(1.0));

// Hoặc: Đẩy sơ đồ vào 1/4 chiều rộng màn hình
svgD3.call(zoom.transform, d3.zoomIdentity.translate(width / 4, height / 2).scale(1.0));

        // Hàm Update (Cập nhật biểu đồ)
        function update(source, forceResize = false) {
            const duration = forceResize ? 0 : 250; // Không có hiệu ứng khi resize

            // Cập nhật layout với kích thước mới
            treeLayout.nodeSize([globalNodeHeight, globalNodeWidth]);
            const treeData = treeLayout(root);
            const nodes = treeData.descendants();
            const links = treeData.links();

            // Cập nhật NÚT (Nodes)
            const node = g.selectAll("g.node")
                .data(nodes, d => d.id);

            const nodeEnter = node.enter().append("g")
                .attr("class", d => `node ${d.depth === 0 ? 'root' : (d._children ? 'collapsed' : (d.children ? 'internal' : 'leaf'))}`)
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .on("click", onClick);

            nodeEnter.append("circle")
                .attr("r", 1e-6);

            nodeEnter.append("text")
                .text(d => d.data.name)
                .attr("dy", "0.31em")
                .style("opacity", 0);

            const nodeUpdate = node.merge(nodeEnter)
                .transition().duration(duration)
                .attr("transform", d => `translate(${d.y},${d.x})`)
                .attr("class", d => `node ${d.depth === 0 ? 'root' : (d._children ? 'collapsed' : (d.children ? 'internal' : 'leaf'))}`);
            
            nodeUpdate.select("circle")
                .attr("r", d => (d.depth === 0 ? 10 : (d._children || d.children ? 8 : 6)) * globalElementScale) // Áp dụng scale
                .attr("class", d => d._children ? "collapsed" : (d.children ? "internal" : "leaf"));

            nodeUpdate.select("text")
                .attr("x", d => (d.children || d._children) ? (-12 * globalElementScale) : (12 * globalElementScale)) // Áp dụng scale
                .style("font-size", `${12 * globalElementScale}px`) // Áp dụng scale
                .style("opacity", 1);

            const nodeExit = node.exit().transition().duration(duration)
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .style("opacity", 0)
                .remove();

            nodeExit.select("circle").attr("r", 1e-6);
            nodeExit.select("text").style("opacity", 1e-6);

            // Cập nhật LIÊN KẾT (Links)
            const linkGenerator = d3.linkHorizontal().x(d => d.y).y(d => d.x);
            const link = g.selectAll("path.link").data(links, d => d.target.id);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", d => {
                    const o = { x: source.x0, y: source.y0 };
                    return linkGenerator({ source: o, target: o });
                });

            link.merge(linkEnter).transition().duration(duration)
                .attr("d", linkGenerator);

            link.exit().transition().duration(duration)
                .attr("d", d => {
                    const o = { x: source.x, y: source.y };
                    return linkGenerator({ source: o, target: o });
                })
                .remove();
            
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Xử lý sự kiện Click vào nút
        function onClick(event, d) {
            if (settingsPanel.classList.contains('open')) {
                settingsPanel.classList.remove('open');
            }
            event.stopPropagation(); // Ngăn click lan ra SVG

            if (d.depth === 0 && !d.children && !d._children) return; // Không làm gì nếu là nút gốc không con

            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            update(d);
        }
        
        // Hàm resize cho D3 (được gọi bởi hàm resize của Three.js)
        function resizeD3() {
            width = window.innerWidth;
            height = window.innerHeight;
            svgD3.attr("viewBox", [0, 0, width, height]);
        };

        // Chạy hàm update D3 lần đầu tiên
        update(root);
        
        // --- CÁC THANH TRƯỢT ĐIỀU KHIỂN ---
        const settingsToggle = document.getElementById('settings-toggle-icon');
        const settingsPanel = document.getElementById('settings-panel');
        
        // Ngăn click vào bảng điều khiển lan ra SVG (khiến nó tự đóng)
        settingsPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        const sizeSlider = document.getElementById('element-size-slider');
        const vSlider = document.getElementById('vspacing-slider');
        const hSlider = document.getElementById('spacing-slider');

        // Mở/Đóng Bảng Cài Đặt
        settingsToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsPanel.classList.toggle('open');
        });

        // 1. Thanh Kích thước Chữ/Nút (Px)
        sizeSlider.addEventListener('input', (e) => {
            globalElementScale = +e.target.value;
            update(root, true); // Cập nhật ngay (forceResize = true)
        });

        // 2. Thanh Khoảng cách Dọc (Vertical)
        vSlider.addEventListener('input', (e) => {
            globalNodeHeight = +e.target.value;
            update(root, true); // Cập nhật ngay
        });

        // 3. Thanh Khoảng cách Ngang (Horizontal)
        hSlider.addEventListener('input', (e) => {
            globalNodeWidth = +e.target.value;
            update(root, true); // Cập nhật ngay
        });
        
    </script>
</body>
</html>
